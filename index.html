<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a2e;
            --chat-bg: #282a47;
            --text-color: #f0f0f0;
            --accent-color: #f99d1c;
            --shadow-color: rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 900px;
            height: 90vh;
            background-color: var(--chat-bg);
            border-radius: 15px;
            box-shadow: 0 10px 30px var(--shadow-color);
            display: none;
            flex-direction: row;
            overflow: hidden;
        }

        .auth-container {
            width: 100%;
            max-width: 400px;
            background-color: var(--chat-bg);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px var(--shadow-color);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .auth-container h2 {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--accent-color);
        }

        .input-group {
            width: 100%;
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .input-group input {
            width: 93%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background-color: #383a60;
            color: var(--text-color);
            font-size: 1em;
            outline: none;
        }

        .auth-button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background-color: var(--accent-color);
            color: #1a1a2e;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .auth-button:hover {
            background-color: #ffb84d;
            transform: translateY(-2px);
        }

        #auth-message {
            margin-top: 20px;
            font-weight: 600;
        }

        .switch-mode {
            margin-top: 20px;
            color: #c9c9e0;
            cursor: pointer;
        }

        .chat-sidebar {
            flex: 0 0 250px;
            background-color: #31335a;
            padding: 10px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .chat-sidebar::-webkit-scrollbar { width: 8px; }
        .chat-sidebar::-webkit-scrollbar-thumb { background-color: var(--accent-color); border-radius: 4px; }
        
        .user-list-item {
            display: flex;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }
        
        .user-list-item:hover, .user-list-item.selected {
            background-color: #444670;
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .messages-container {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .messages-container::-webkit-scrollbar { width: 8px; }
        .messages-container::-webkit-scrollbar-thumb { background-color: var(--accent-color); border-radius: 4px; }

        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            word-wrap: break-word;
        }
        
        .message.sent {
            align-self: flex-end;
            background-color: var(--accent-color);
            color: #1a1a2e;
        }
        
        .message.received {
            align-self: flex-start;
            background-color: #555883;
            color: var(--text-color);
        }

        .message img {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .message-input-area {
            padding: 15px;
            background-color: #31335a;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #message-input {
            flex-grow: 1;
            padding: 10px;
            border: none;
            border-radius: 20px;
            background-color: #444670;
            color: var(--text-color);
            font-size: 1em;
            outline: none;
        }

        #send-button {
            background-color: var(--accent-color);
            border: none;
            color: #1a1a2e;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }

        #image-upload {
            display: none;
        }
        
        .image-upload-label {
            cursor: pointer;
            font-size: 2em;
            color: var(--accent-color);
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .chat-sidebar {
                flex-basis: 150px;
            }
            .chat-main {
                flex-grow: 1;
            }
        }
    </style>
</head>
<body>

    <div class="auth-container" id="auth-section">
        <h2 id="form-title">‡¶≤‡¶ó‡¶á‡¶®</h2>
        <div class="input-group">
            <label for="email">‡¶á‡¶Æ‡ßá‡¶á‡¶≤:</label>
            <input type="email" id="email" placeholder="‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" required />
        </div>
        <div class="input-group">
            <label for="password">‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°:</label>
            <input type="password" id="password" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" required />
        </div>
        <button id="auth-button" class="auth-button">‡¶≤‡¶ó‡¶á‡¶®</button>
        <p id="auth-message"></p>
        <p class="switch-mode">‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞? ‡¶∏‡¶æ‡¶á‡¶®-‡¶Ü‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®</p>
    </div>

    <div class="container" id="chat-section">
        <div class="chat-sidebar">
            <h3 style="color: var(--text-color);">‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</h3>
            <div id="user-list"></div>
        </div>
        <div class="chat-main">
            <div id="current-chat-header" style="text-align: center; padding: 10px; background-color: #383a60; font-size: 1.2em;">
                ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
            </div>
            <div class="messages-container" id="messages-container">
                </div>
            <div class="message-input-area">
                <label for="image-upload" class="image-upload-label">üñºÔ∏è</label>
                <input type="file" id="image-upload" accept="image/*">
                <input type="text" id="message-input" placeholder="‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." />
                <button id="send-button">‡¶™‡¶æ‡¶†‡¶æ‡¶®</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>
    
    <script>
        // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Firebase ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        const firebaseConfig = {
          apiKey: "AIzaSyBcDC4UMsTgo2IAXUxmTF2UqpvgfRWOwas",
          authDomain: "live-tv-9521d.firebaseapp.com",
          databaseURL: "https://live-tv-9521d-default-rtdb.firebaseio.com",
          projectId: "live-tv-9521d",
          storageBucket: "live-tv-9521d.firebasestorage.app",
          messagingSenderId: "475229762007",
          appId: "1:475229762007:web:9a42815a3bd43acabf5b92",
          measurementId: "G-RH9L4JG4WT"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();

        const authSection = document.getElementById('auth-section');
        const chatSection = document.getElementById('chat-section');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authButton = document.getElementById('auth-button');
        const authMessage = document.getElementById('auth-message');
        const formTitle = document.getElementById('form-title');
        const switchMode = document.querySelector('.switch-mode');
        const userList = document.getElementById('user-list');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const imageUpload = document.getElementById('image-upload');
        const currentChatHeader = document.getElementById('current-chat-header');

        let isLoginMode = true;
        let currentUser;
        let recipientId = null;

        function showMessage(message, isError = false) {
            authMessage.textContent = message;
            authMessage.style.color = isError ? 'red' : 'green';
        }

        switchMode.addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            formTitle.textContent = isLoginMode ? '‡¶≤‡¶ó‡¶á‡¶®' : '‡¶∏‡¶æ‡¶á‡¶®-‡¶Ü‡¶™';
            authButton.textContent = isLoginMode ? '‡¶≤‡¶ó‡¶á‡¶®' : '‡¶∏‡¶æ‡¶á‡¶®-‡¶Ü‡¶™';
            switchMode.textContent = isLoginMode ? '‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞? ‡¶∏‡¶æ‡¶á‡¶®-‡¶Ü‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®' : '‡¶Ü‡¶ó‡ßá ‡¶•‡ßá‡¶ï‡ßá ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá? ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®';
            authMessage.textContent = '';
        });

        authButton.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;

            if (isLoginMode) {
                auth.signInWithEmailAndPassword(email, password).catch((error) => {
                    showMessage('‡¶≤‡¶ó‡¶á‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶ì ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®‡•§', true);
                });
            } else {
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;
                        database.ref(`users/${user.uid}`).set({
                            email: user.email,
                            online: true,
                            lastSeen: new Date().toISOString()
                        });
                        showMessage('‡¶∏‡¶æ‡¶á‡¶®-‡¶Ü‡¶™ ‡¶∏‡¶´‡¶≤! ‡¶è‡¶ñ‡¶® ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                        isLoginMode = true;
                        formTitle.textContent = '‡¶≤‡¶ó‡¶á‡¶®';
                        authButton.textContent = '‡¶≤‡¶ó‡¶á‡¶®';
                        switchMode.textContent = '‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞? ‡¶∏‡¶æ‡¶á‡¶®-‡¶Ü‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®';
                    })
                    .catch((error) => {
                        showMessage('‡¶∏‡¶æ‡¶á‡¶®-‡¶Ü‡¶™ ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§', true);
                    });
            }
        });

        function renderMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(message.senderId === currentUser.uid ? 'sent' : 'received');

            if (message.imageUrl) {
                const image = document.createElement('img');
                image.src = message.imageUrl;
                messageElement.appendChild(image);
            }
            if (message.text) {
                const textNode = document.createTextNode(message.text);
                messageElement.appendChild(textNode);
            }

            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function loadMessages(senderId, recipientId) {
            messagesContainer.innerHTML = '';
            database.ref(`messages/${senderId}/${recipientId}`).off(); // Remove previous listener
            database.ref(`messages/${recipientId}/${senderId}`).off(); // Remove previous listener

            const chatRef = database.ref(`messages/${senderId}/${recipientId}`);
            chatRef.on('child_added', (snapshot) => {
                renderMessage(snapshot.val());
            });
            const chatRef2 = database.ref(`messages/${recipientId}/${senderId}`);
            chatRef2.on('child_added', (snapshot) => {
                renderMessage(snapshot.val());
            });
        }
        
        function updateRecipient(newRecipientId, recipientName) {
            if (recipientId === newRecipientId) return;

            recipientId = newRecipientId;
            currentChatHeader.textContent = recipientName;
            messagesContainer.innerHTML = '';
            
            document.querySelectorAll('.user-list-item').forEach(el => el.classList.remove('selected'));
            document.getElementById(`user-${recipientId}`).classList.add('selected');

            loadMessages(currentUser.uid, recipientId);
        }

        function sendMessage(text, imageUrl = null) {
            if (!recipientId) {
                alert('‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ï‡¶ú‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                return;
            }
            const message = {
                senderId: currentUser.uid,
                recipientId: recipientId,
                text: text,
                imageUrl: imageUrl,
                timestamp: Date.now()
            };

            const newMessageKey = database.ref().child('messages').push().key;
            const updates = {};
            updates[`messages/${currentUser.uid}/${recipientId}/${newMessageKey}`] = message;
            updates[`messages/${recipientId}/${currentUser.uid}/${newMessageKey}`] = message;
            database.ref().update(updates);
        }

        sendButton.addEventListener('click', () => {
            const messageText = messageInput.value.trim();
            if (messageText) {
                sendMessage(messageText);
                messageInput.value = '';
            }
        });

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });

        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const storageRef = storage.ref(`images/${file.name}`);
                const uploadTask = storageRef.put(file);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        // Optional: show progress bar
                    },
                    (error) => {
                        console.error('Image upload failed', error);
                        alert('‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
                    },
                    () => {
                        uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                            sendMessage(null, downloadURL);
                        });
                    }
                );
            }
        });

        // Auth state change listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                authSection.style.display = 'none';
                chatSection.style.display = 'flex';
                database.ref(`users/${currentUser.uid}`).update({
                    online: true
                });

                // Load user list
                database.ref('users').on('value', (snapshot) => {
                    const users = snapshot.val();
                    userList.innerHTML = '';
                    for (const uid in users) {
                        if (uid !== currentUser.uid) {
                            const user = users[uid];
                            const userListItem = document.createElement('div');
                            userListItem.id = `user-${uid}`;
                            userListItem.className = 'user-list-item';
                            userListItem.textContent = user.email.split('@')[0]; // Show part of email as username
                            userListItem.addEventListener('click', () => updateRecipient(uid, user.email.split('@')[0]));
                            userList.appendChild(userListItem);
                        }
                    }
                });

            } else {
                authSection.style.display = 'flex';
                chatSection.style.display = 'none';
                currentUser = null;
            }
        });
    </script>
</body>
</html>
